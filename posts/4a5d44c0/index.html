<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#3367D6"/>
  <link rel="apple-touch-icon" href="/icons-192.png">
  <link rel="manifest" href="/manifest.json">
  


  <meta name="generator" content="Hexo 6.3.0">

  

  
    <meta name="keywords" content="游戏开发">
  

  
    <meta name="author" content="kio0o0">
  

  

  

  <title>《Unity性能优化》-- 5. 性能优化实战 | 不特别周のBlog</title>

  

  
    <link rel="shortcut icon" href="/favicon.ico">
  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@1.1.3/index.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlightjs@9.16.2/styles/monokai.css">
  

  
<link rel="stylesheet" href="/css/style.css">

</head>
<body>
  <div class="root-container">
    
<!-- header container -->
<header class="header-container post">
  
    <div class="post-image" style="background-image: url(https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/20230104211338.png)"></div>
  

  <!-- navbar -->
<nav class="navbar">
  <div class="navbar-content">
    <!-- logo -->
    <div class="navbar-logo">
      <a href="/">
        
          不特别周のBlog
        
      </a>
    </div>
    <!-- link -->
    <div class="navbar-link">
      <div class="navbar-btn">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <ul class="navbar-list">
        
          <li class="navbar-list-item"><a href="/">首页</a></li>
        
          <li class="navbar-list-item"><a href="/talks">叨叨</a></li>
        
      </ul>
    </div>
  </div>
</nav>

  
  

  
  

  
  

  
  

  
  
    <div class="header-content">
      <div class="post-text layout-block">
        <div class="layout-margin">
          <h1 class="title-wrap">《Unity性能优化》-- 5. 性能优化实战</h1>
          <h2 class="title-sub-wrap">
            <strong>kio0o0</strong>
            <span>发布于</span>
            <time  class="article-date" datetime="2023-04-12T10:14:16.000Z" itemprop="datePublished">2023-04-12</time>
          </h2>
          
            <h2 class="title-sub-wrap new-date">
              <span>最后更新于</span>
              <time  class="article-updated" datetime="2024-07-14T09:03:59.236Z" itemprop="dateUpdated">2024-07-14</time>
            </h2>
          
          
          <ul class="wrap-list dark">
  
    <li><a href="/categories/%E5%AD%A6%E4%B9%A0/">📒 学习</a></li>
  
</ul>
          <ul class="wrap-list dark">
  
    <li><a href="/tags/Unity/">🏷️ Unity</a></li>
  
    <li><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">🏷️ 性能优化</a></li>
  
</ul>
        </div>
      </div>
    </div>
  

  
  
  
</header>

    <!-- 文章 -->

<!-- 文章内容 -->
<div class="body-container">
  <article class="content-container layout-block post-container">
    <div class="article-info">
      
      
      
      
      <section class="article-entry markdown-body layout-margin content-padding--large soft-size--large soft-style--box">
        <span id="more"></span>
<h2 id="性能总览与瓶颈定位">性能总览与瓶颈定位</h2>
<h3 id="优化方向">优化方向</h3>
<ul>
<li>先优化iOS，再优化Android（iOS分析工具齐全，以及机型少、系统统一）</li>
<li>先共性性能优化，再兼容性方面的性能优化</li>
</ul>
<h3 id="常用工具">常用工具</h3>
<ul>
<li>Profiler</li>
<li>Frame Debugger</li>
<li>Memory Profiler</li>
<li>Profile Analyzer</li>
<li>UPR 工具</li>
<li><a target="_blank" rel="noopener" href="https://github.com/nvpro-samples/gl_dynamic_lod/issues/1">NsightGraphics</a></li>
<li>Xcode（十分强大）</li>
</ul>
<h3 id="瓶颈定位">瓶颈定位</h3>
<h4 id="通过Profiler工具">通过Profiler工具</h4>
<p><img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304121633377.png" alt=""><br>
<img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304121643145.png" alt=""></p>
<ul>
<li>初步观察示例项目，发现Gfx.WaitForPresentOnGfxThread占用比较高</li>
<li>这是主线程在等待渲染线程完成工作</li>
<li>这种情况一般是GPU瓶颈或者CPU与GPU的带宽阻塞</li>
<li>同时观察Timeline，查看一帧中渲染进程谁占用比较高</li>
<li>这里是PostProcess进程，但也不能武断判断他就是渲染瓶颈，需要尝试手动屏蔽</li>
</ul>
<h4 id="Unity常见的等待函数">Unity常见的等待函数</h4>
<table>
<thead>
<tr>
<th>等待函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>WaitForTargetFPS</td>
<td>等待达到目标帧率，一般这种情况CPU与GPU都没什么负载问题</td>
</tr>
<tr>
<td>Gfx.WaitForGfxCommandsFromMainThread/WaitForCommand</td>
<td>渲染线程己经准备接受新的渲染命令，一般瓶颈在CPU</td>
</tr>
<tr>
<td>Gfx.WaitForPresentOnGfxThread/WaitForPresent</td>
<td>主线程等待渲染线程绘制完成，一般瓶颈在GPU</td>
</tr>
<tr>
<td>WaitForJobGroupID</td>
<td>等待工作线程完成，一般瓶颈在CPU</td>
</tr>
</tbody>
</table>
<h4 id="GPU或带宽瓶颈型游戏优化">GPU或带宽瓶颈型游戏优化</h4>
<ul>
<li>渲染流程与效果优化</li>
<li>渲染中生成资源优化</li>
<li>DrawCall与SetPassCall</li>
<li>片元着色器</li>
<li>渲染三角形</li>
</ul>
<h4 id="记录结果很重要">记录结果很重要</h4>
<ul>
<li>需要记录优化前的报告</li>
<li>从而对比优化后的成果</li>
<li>不然没有说服力</li>
</ul>
<h2 id="渲染流程分析">渲染流程分析</h2>
<blockquote>
<p>通过Frame Debug查看主要渲染流程，以下是课程项目中的渲染流程</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/20230412170723.png" alt=""></p>
<h3 id="Xcode-Metal-Capture">Xcode Metal Capture</h3>
<blockquote>
<p>需要在Scheme中Option选项开启Gpu Frame Capture</p>
</blockquote>
<ul>
<li>提供十分强大的分析工具，包括各种资源使用情况，当前线程开启情况等</li>
<li>还可以抓帧分析，每帧所有指令的耗时以及渲染流程清晰可见</li>
<li>经验：任何超过1ms的渲染步骤都值得关注，尽量将GPU耗时控制在10ms</li>
<li>Xcode工具会将有问题的流程标上三角叹号</li>
<li>该工具每个指令还提供：
<ul>
<li>Attachments</li>
<li>Geometry</li>
<li>Bound Resources，当前使用的资源</li>
<li>All Resources，整体使用的资源</li>
<li>Pipeline Statisitics，渲染管线分析</li>
<li>Performance，渲染性能分析</li>
<li>CallStack，渲染api回调<br>
<img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304121724969.png" alt=""></li>
</ul>
</li>
</ul>
<h2 id="与设备分辨率相关的GPU开销优化">与设备分辨率相关的GPU开销优化</h2>
<h3 id="SSAO优化">SSAO优化</h3>
<ul>
<li>通过Xcode Metal Capture查看SSAO第一个pass耗时十分多</li>
<li>查看其引用的资源，发现使用的纹理分辨率非常高，容易造成gpu采样瓶颈和带宽瓶颈</li>
<li>查看渲染管线分析，主要耗时在ALU time和Wait time，基本证实片元着色器片元压力大以及带宽瓶颈</li>
<li>查看性能分析，主要问题还是片元指令，片元指令过多以及缓存命中率低</li>
<li>Timeline和Counters可以看到带宽读写、顶点与片元占用率、ALU逻辑单元运行、Cache缓存命中率等情况</li>
<li>主要优化：
<ul>
<li>降采样中间纹理，可修改srp源码对中间模糊纹理也降采样</li>
<li>将ao执行挪到不透明物体pass后面，提高移动端tbdr效率</li>
<li>适当调低ssao采样半径选项</li>
<li>采样次数，越低越好</li>
<li>改进ao图像模糊算法（单pass或其他算法），或者直接不使用（降分辨率本身就是一种模糊）</li>
</ul>
</li>
<li>进一步优化：
<ul>
<li>使用hbao、gtao 方案</li>
<li>针对SSAO的Shader指令做进一步优化</li>
<li>采样烘焙AO到光照贴图的方案替换SSAO</li>
</ul>
</li>
<li>优化后总耗时降低比ssao降低秒数还多：
<ul>
<li>填充率提高了</li>
<li>SSAO 的占用资源减少之后，减少了其它环节的阻塞</li>
<li>缓存命中提高了</li>
</ul>
</li>
</ul>
<h3 id="AA优化">AA优化</h3>
<h4 id="反走样方案的发展">反走样方案的发展</h4>
<ul>
<li>第一代：SSAA（超级采样抗锯齿Super-Sampling Anti-Aliasing )</li>
<li>第二代：（URP目前主要方案）
<ul>
<li>MSAA（多重采样抗锯齿 Multi Sampling Anti-Aliasing）</li>
<li>FXAA（快速近似抗锯齿Fast Approximate Anti-Aliasing)</li>
<li>SMAA（增强子像素形变抗锯齿Enhanced Subpixel Morphological Anti-Aliasing )</li>
</ul>
</li>
<li>第三代：TAA（时间序列抗锯齿Temporal Anti-Aliasing），目前还没有接入URP，可以使用PPV2包，但是不支持urp的motion vector，鬼影会比较严重</li>
<li>第四代：DLSS（基于深度学习的超级采样Deep Learning super Sampling )，需要特殊硬件支持，目前只有hdrp的pc平台（康康fsr）</li>
</ul>
<blockquote>
<p>注：这里只列出了Unity反走样的一些发展流程，其他反走样方案这里不包括</p>
</blockquote>
<h4 id="URP中的AA方案">URP中的AA方案</h4>
<table>
<thead>
<tr>
<th>方案</th>
<th>URP支持</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>MSAA</td>
<td>URP默认支持，适合绝大多数非延迟渲染游戏</td>
<td>显卡硬件支持，反走样效果较好</td>
<td>仅支持前向渲，静态画面表现最好，运动画面一般，支持MRT的情况下效率较差，只能消除Geometry的反走样，对于高光像素部分无能为力</td>
</tr>
<tr>
<td>FXAA</td>
<td>URP默认支持，有Quality与Console两个不同版本，Quality版本需要PPV2.适合一些对低端硬件有要求、对画面模糊不敏感的特殊游戏</td>
<td>后处理支持开销非常小，适合移动端</td>
<td>没有格外像素辅助，在高频颜色变化快的地方，动态场景会出现闪烁，对图形所有颜色边缘进行柔化处理 ，导致画面整体较模糊</td>
</tr>
<tr>
<td>SMAA</td>
<td>URP默认支持，适合一些对低端硬件有要求的特殊游戏</td>
<td>后处理支持，开销相对较小，适合低端PC端</td>
<td>没有格外像素辅助 ，在高频颜色变化快的地方，动态场景会出现闪烁，三次pass，开销相对FXAA高一些，切换RT开销在手机上可能造成开销，边缘处理比FXAA精细些，但依然有模糊表现</td>
</tr>
<tr>
<td>TAA</td>
<td>URP末来支持，可用PPV2扩展支持</td>
<td>支持延迟渲染，反走样效果较好，性能开销较小</td>
<td>动态场景下，低帧率下可能出现鬼影，无法处理半透明物体、贴图序列帧动画物体，需要额外内存开销,需要MotionVector Buffer</td>
</tr>
</tbody>
</table>
<p>效率：FXAA&gt;SMAA&gt;TAA&gt;MSXX<br><br>
质量：MSAA&gt;SMAA&gt;TAA&gt;FXAA(这里的TAA支持并不完整在urp中)</p>
<h4 id="优化手段">优化手段</h4>
<ul>
<li>调低SMAA的质量选项</li>
<li>优化SMAA中间pass的中间纹理带宽开销，利用metal片上内存，修改为memoryless模式、以及storeaction</li>
<li>使用FXAA代替，有几毫米改进</li>
<li>评估是否需要AA，手机DPI较大，色彩跳动较下</li>
</ul>
<h4 id="优化示例工程AA方案总结">优化示例工程AA方案总结</h4>
<ul>
<li>高端移动设备上采用优化后的SMAA或FXAA, Unity默认URP<br>
下的TAA成熟后，根据性能与表现均衡选择采用</li>
<li>中端移动设备上采用FXAA方式或关闭AA渲染</li>
<li>低端移动设备上关闭AA渲染</li>
</ul>
<h3 id="PostProcess后处理优化">PostProcess后处理优化</h3>
<h4 id="Unity-URP下支持的后处理效果分类">Unity URP下支持的后处理效果分类</h4>
<ol>
<li>色彩校正与增强（一般开销较低，但不可胡乱堆砌）</li>
</ol>
<ul>
<li>Channel Mixer</li>
<li>Color Adjustment</li>
<li>Color Curves</li>
<li>Lift，Gamma and Gain</li>
<li>Shadows/Midtones/Highlights</li>
<li>Tonemapping</li>
<li>White Balance</li>
<li>Split Toning</li>
</ul>
<ol start="2">
<li>画面效果增强（一般需要额外PASS，涉及RT切换和采样，开销一般较高。建议使用local volume视条件开启）</li>
</ol>
<ul>
<li>Bloom</li>
<li>Chromatic Aberration</li>
<li>Depth Of Field</li>
<li>Film Grain</li>
<li>Motion Blur</li>
</ul>
<ol start="3">
<li>镜头效果（开销中等，主要是shader计算，建议视情况开启而不要全局）</li>
</ol>
<ul>
<li>Lens Disortion</li>
<li>Panini Projection</li>
<li>Vignette</li>
<li>Lens Flare</li>
</ul>
<h4 id="Unity-URP下支持的后处理效果列表">Unity URP下支持的后处理效果列表</h4>
<table>
<thead>
<tr>
<th>效果列表</th>
<th>描述</th>
<th>移动端性能开销</th>
<th>常用性</th>
<th>优化方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bloom</td>
<td>泛光、镜头污垢</td>
<td>中高</td>
<td>高</td>
<td>降采样、降低迭代次数、替换2遍模糊pass算法（ue有提出移动端的优化手段）。</td>
</tr>
<tr>
<td>Channel Mixer</td>
<td>通道混合器</td>
<td>非常低</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Chromatic Aberration</td>
<td>散色像差，用于模拟相机的镜头无法将颜色聚合在一起的颜色失真效果（机器人视觉、屏幕破碎）</td>
<td>中低（需要三遍采样）</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Color Adiustment</td>
<td>颜色调整</td>
<td>中</td>
<td>高</td>
<td>ColorGradingMode(HDR or LDR)，如果支持浮点精度计算的平台或设备，HDR模式效率会更高</td>
</tr>
<tr>
<td>Color Curves</td>
<td>颜色曲线</td>
<td>低</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Depth Of Field</td>
<td>景深</td>
<td>非常高</td>
<td>中低</td>
<td>切换Gaussian与Bokeh的景深模式，移动平台建议用Gaussian</td>
</tr>
<tr>
<td>Film Grain</td>
<td>胶片颗粒</td>
<td>中（需要采样多张Lookup纹理，可以修改LUT纹理大小）</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Lens Disortion</td>
<td>镜头失真</td>
<td>中低</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Lift, Gamma,and Gain</td>
<td>提升、伽马与增益</td>
<td>非常低</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Motion Blur</td>
<td>运动模糊</td>
<td>高（需要MotionVector）</td>
<td>中低</td>
<td>MotionBlur质量分级、Intensity强度、Clamp摄像机旋转产生的速度可以具有的最大长度</td>
</tr>
<tr>
<td>Panini Projection</td>
<td>Panini投影</td>
<td>中</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Shadows、Midtones、Highlights</td>
<td>阴影、中间调与高光</td>
<td>中低</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Split Toning</td>
<td>拆分着色</td>
<td>非常低</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Tonemapping</td>
<td>色调映射</td>
<td>中</td>
<td>中</td>
<td>几乎无</td>
</tr>
<tr>
<td>Vignette</td>
<td>渐晕，四边暗角，一般用于无ui动画或截图</td>
<td>中</td>
<td>低</td>
<td>Intensity与Smoothness</td>
</tr>
<tr>
<td>White Balance</td>
<td>白平衡</td>
<td>中低</td>
<td>低</td>
<td>几乎无</td>
</tr>
<tr>
<td>Lens Flare</td>
<td>镜头光晕</td>
<td>中高</td>
<td>中</td>
<td>Occlusion设置与光晕数量</td>
</tr>
</tbody>
</table>
<h4 id="优化手段-2">优化手段</h4>
<ul>
<li>去除不需要的后处理效果（最好是移除，不勾选复选框也会绑定资源，造成内存浪费）</li>
<li>有优化空间的后处理效果看上表</li>
<li>尽量不要全局使用volume效果</li>
</ul>
<h2 id="与场景复杂度相关的GPU开销优化">与场景复杂度相关的GPU开销优化</h2>
<blockquote>
<p>先从整体开销判断是不是场景复杂度瓶颈，一般看前向渲染（如果延迟渲染可以看阴影开销）各个阶段的DrawCall</p>
</blockquote>
<blockquote>
<p>条件允许优先做Simplization，接着Culling，最后才是Batching</p>
</blockquote>
<h3 id="常用观察数据">常用观察数据</h3>
<ul>
<li>Batches          drawcall数量</li>
<li>Tris             三角形数</li>
<li>Verts            顶点数</li>
<li>setpass calls</li>
<li>shadowcasters    投影体数量</li>
</ul>
<h3 id="Simplization简化">Simplization简化</h3>
<h4 id="场景简化总览">场景简化总览</h4>
<ul>
<li>用编辑器的线框模式查看顶点和三角形分别情况</li>
<li>使用Rendering Debug 查看overdraw信息</li>
<li>使用Rendering Debug 查看级联阴影设置情况</li>
</ul>
<h4 id="地形分类">地形分类</h4>
<table>
<thead>
<tr>
<th>场景</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>远景</td>
<td>视距较远，主要用于表现开阔景物，为了渲染总体气氛和空间感，配合景深使层次感更丰富，增加整体意境，一般不需要具体细节表现</td>
</tr>
<tr>
<td>中景</td>
<td>画面视觉中心的部分，进一步烘托场景气氛，需要一定视觉和细节表现，但不需要过分强调，更多通过材质颜色、质地、大范围光影明暗来呈现</td>
</tr>
<tr>
<td>近景</td>
<td>视距最近的画面部分，突出表现具体某个物体或角色上，需要突出表现材质细节，凹凸、光影细节、反射折射投射等，通过近景与中景远景的占比更好突出场景透视感</td>
</tr>
</tbody>
</table>
<p>可以通过LOD来配合远中近景使用，一般层级不宜超过5级（原模型-简化1-简化2-替代体-剔除），不需要替代体的一般是4级，如果只在近景可见那就是两级了（原模型-剔除）</p>
<h4 id="远景简化">远景简化</h4>
<p>远景不可达地形使用天空盒烘焙，而不用真实网格</p>
<ul>
<li>反射探针烘焙cubemap</li>
<li>legacy-&gt;cubemap（旧的方法，unity可能会舍弃）</li>
<li>Camera.RenderToCubemap</li>
</ul>
<h4 id="中景简化">中景简化</h4>
<ul>
<li>配合overdraw视图进行LOD简化，使用DCC软件制作或者Unity插件
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Whinarn/UnityMeshSimplifier">UnityMeshSimplifier</a>简化Mesh</li>
<li>替代体生成Amplify Imposters与Runtime Imposters</li>
</ul>
</li>
<li>要小心Quality setting中的LOD Bias</li>
<li>对一些简化后的LOD层级物体去除阴影投影，减少投影体数量</li>
<li>对一些静态光照物体，已经处于阴影体内也不必要开启投影体，视项目而定，毕竟可以开启SSAO弥补下</li>
</ul>
<h3 id="Culling剔除">Culling剔除</h3>
<h4 id="遮挡剔除与灯关剔除">遮挡剔除与灯关剔除</h4>
<p>遮挡剔除Occlusion Culling是在CPU端做的优化，GPU可以通过延迟渲染、前向渲染配合EarlyZ|PreZ进行优化</p>
<ul>
<li>需要在对应相机开启Occlusion Culling选项</li>
<li>对场景中设置成静态遮挡体或被遮挡体起作用</li>
<li>对应动态物体，比如门窗，可以通过添加Occlusion Portal 组件</li>
<li>注意需要烘焙场景，可以设置烘焙精度</li>
</ul>
<p>对于不需要向其他物体投影的物体可以关闭投影选项（比如平坦的地形）</p>
<p>灯关方面的剔除</p>
<ul>
<li>充分利用tbdr、forward+架构</li>
<li>前期注意使用urp的light layer功能</li>
<li>如果后期无法大量修改资源了，也可以通过脚本来控制灯光的开启</li>
<li>调整Quality urp setting中的灯光设置
<ul>
<li>主光源阴影贴图分辨率</li>
<li>每个对象最多受光源数量</li>
<li>额外光源的shadow Atlas resolution大小（这个是所有额外光源共享的纹理）</li>
</ul>
</li>
<li>调整Quality urp setting中的级联阴影设置</li>
</ul>
<h3 id="Batching合批">Batching合批</h3>
<p>不支持SRP Batcher的物体最好放在不透明渲染队列最后面，避免打断其他合批</p>
<h3 id="Terrain优化">Terrain优化</h3>
<p>内置Terrain方案在移动端性能并不高，特别是shader不够轻量。</p>
<p>自己写一套地形烘焙工具</p>
<ul>
<li>根据Terrain Data将mesh信息与混合后的地形纹理烘焙出来</li>
<li>再通过prefab生成地形块</li>
<li>Unity商店也有挺多现成工具：Terrain To Mesh</li>
</ul>
<p>烘焙完网格需要重新Occlusion Culling</p>
<p>如果是平坦地形，不需要自我投影时，请关闭投影选项</p>
<h3 id="主光源级联阴影优化">主光源级联阴影优化</h3>
<ul>
<li>减少级联层级</li>
<li>如果阴影变化不大，没有相关动画，可以将阴影进行缓存，按级联阴影的不同层级定制刷新频率，也是一种LOD思路（<a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv18581528">相关链接</a>）
<ul>
<li>调整阴影的创建和销毁时机</li>
<li>去除渲染目标每帧清空逻辑</li>
<li>调整阴影刷新频率</li>
</ul>
</li>
</ul>
<h2 id="渲染管线精简与优化">渲染管线精简与优化</h2>
<blockquote>
<p>这块需要的知识面比较深，需要多回顾下https://www.bilibili.com/video/BV1i94y1Q7W3</p>
</blockquote>
<p>引擎为了通用考虑，通常会有冗余的流程或资源生成，当项目需要深度优化时，进行管线的精简与优化是有必要的，高效的管线一定是定制化而非通用化的。</p>
<ul>
<li>unity通常需要做加法，因为其管线功能并没有那么强，需要添加新功能或替换已有效率不高的功能</li>
<li>unreal通常需要做减法，因为其管线功能并不一定全需要用到，但其设置和流程与编辑器耦合比较紧密</li>
<li>unity最佳实践还是需要写一套能满足表现需求，又无过多冗余流程的srp管线</li>
</ul>
<h3 id="主要手段">主要手段</h3>
<ul>
<li>使用URP的<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1sG411p737">Native RenderPass</a>，主要是能优化一些需要多PASS的渲染效果（比如延时渲染需要gbuffer生成和着色两个pass，可以优化成一个native pass），主要目的是减少RT切换和读取的开销（节省带宽和内存，使用后Memoryless、load action为dontcare），使tbr架构更高效渲染。需要图形API支持（metal和vulkan)</li>
<li>去除URP为了通用且对于该项目冗余的PASS（绑定了资源又不使用的PASS），需要修改URP源码</li>
<li>考虑是否需要Normal与Depth提前生成的PASS，如果是延迟渲染则是可以不需要的，但一些透明物体又确实是前向渲染（URP 使用unlit着色器对象也会被强制使用前向渲染）。
<ul>
<li>如果开启SSAO发现即使使用了延迟渲染也会生成这个上述Normal、Depth PrePass，需要修改URP源码处理没有额外使用前向渲染不透明物体时不生成这个Pass的情况。（关键字ConfigureInput）</li>
<li>但去除这个pass可能会发现ssao不生效了，原因在于没有正确读取gbuffer中的法线与深度信息，可以将其资源绑定一下，但同时也会打断Native RenderPass了，需要权衡一下。</li>
</ul>
</li>
<li>建议CopyDepth和CopyColor不要在URP设置中开启，而是使用对应相机设置覆写开启，可以将生成纹理生命周期控制在对应功能开启时，而不是实时生成
<ul>
<li>考虑是否需要CopyDepth（常用于深度雾、扫描线等效果）Pass，生成的深度图不能降采样</li>
<li>考虑是否需要CopyColor（常用于扰动、反射、UI上的效果）Pass，生成的颜色图可以降采样，但反射其实可以用SSR或反射探针实现，其他情况可以视条件开启，不需要全程使用</li>
<li>Metal Api下延迟渲染管线除非开启了Native RenderPass否则都会进行CopyDepth（2021 URP）</li>
</ul>
</li>
<li>修改URP源码需要将Library中的PackageCache对应的包拷贝到Packages中，后续如果URP要升级只能手动Merge代码</li>
</ul>
<h2 id="Shader指令优化">Shader指令优化</h2>
<blockquote>
<p>如果要按渲染功能分级优化：Shader LOD</p>
</blockquote>
<blockquote>
<p>Xcode查看Shader总体耗时排名：抓帧后将Group by API Call -&gt; Group by Pipeline State</p>
</blockquote>
<blockquote>
<p>直接在Xcode抓帧中修改Shader后刷新即可看到修改变化</p>
</blockquote>
<h4 id="Shader四类性能指标">Shader四类性能指标</h4>
<ol>
<li>ALU: GPU逻辑处理单元的时间花费
<ul>
<li>Float指令占比过高时：浮点精度修改半浮点精度</li>
<li>Complex过高时：减少sqrt、sin、cos、recip等复杂指令的使用</li>
</ul>
</li>
<li>Memory: 代表访问程序的一些缓冲区或纹理内存的时间花费
<ul>
<li>Sample过高时：纹理降采样</li>
<li>Load/Store过高时：降低分辨率或减少内存读写开销</li>
</ul>
</li>
<li>Control Flow：着色器在分支、循环、增量、跳转等指令上花费的时间。
<ul>
<li>使用恒定的迭代记数来最小化循环时间</li>
<li>使用一些指令替换或优化分支语句</li>
</ul>
</li>
<li>Syuchrouization: 在指令执行前等待所需系统资源或同步事件所花费的时间
<ul>
<li>wait Memory：等待内存访问，如纹理采样或缓冲区读写Memory类的优化同样会改善此类同步问题</li>
<li>wait Pixel:等待像素资源释放，除ColorAttachment外这些像素还来自深度与模版缓冲区或者用户自定义资源，Blender是造成像素等待的常见情况，合理的光栅化对象顺序（渲染排序）来减少等待时间</li>
<li>Wait Barriar：等待同一组中其余线程完成，合理的compute shader group分组与线程分组可以改善这一情况</li>
<li>Wait Atomic：等待原语指令同步，很难优化</li>
</ul>
</li>
</ol>
<h4 id="Shader数据类型精度">Shader数据类型精度</h4>
<ul>
<li>Float（32bit）（位置与纹理坐标信息时使用）</li>
<li>Half（16bit）（纹理坐标与颜色信息时使用）</li>
<li>Fixed（11bit）（颜色信息）（SRP下已不支持）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304171057783.png" alt=""></p>
<h4 id="尽量使用内置函数">尽量使用内置函数</h4>
<blockquote>
<p>不要自己造轮子，内置函数有ALU单元优化</p>
</blockquote>
<ul>
<li>pow</li>
<li>normalize</li>
<li>dot</li>
<li>inversesqrt</li>
<li>…</li>
</ul>
<h4 id="超越函数">超越函数</h4>
<blockquote>
<p>一些变量之间关系不能用有限次加减乘除、乘方、开方运算表示的函数，这些函数在芯片上计算属于资源密集型函数，在低端设备上要慎用少用</p>
</blockquote>
<ul>
<li>exp</li>
<li>log</li>
<li>sin,cos,tan…</li>
<li>asin,acos,atan,atan2…</li>
<li>sincos</li>
<li>…</li>
</ul>
<h4 id="指令周期与阶段">指令周期与阶段</h4>
<p><img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304171102865.png" alt=""></p>
<h4 id="指令优化">指令优化</h4>
<ul>
<li>mul + add =&gt; mad
<ul>
<li>(x-0.5)*1.5 -&gt; ×*1.5+(-0.75)</li>
</ul>
</li>
<li>除法 =&gt; rcp
<ul>
<li>(t.x * t.y + t.z) / t.x -&gt; t.y + t.z * ( 1.0 / t.x )</li>
</ul>
</li>
<li>对齐
<ul>
<li>float3 * float * float * float3 -&gt; (float*float) * (float3*float3)</li>
</ul>
</li>
<li>abs或neg指令输出 =&gt; 输入
<ul>
<li>abs(a.x * a.y) -&gt; abs(a.x) * abs(a.y)</li>
<li>-(a.x*a.y) -&gt; -a.× * a.y</li>
</ul>
</li>
<li>saturate指令输入 =&gt; 输出
<ul>
<li>1.0-saturate(a) -&gt; saturate(1.0-a)</li>
</ul>
</li>
<li>min或max =&gt; saturate (某些平合）
<ul>
<li>max(x, 0.0) = min (x, 1.0) -＞ saturate (x)</li>
</ul>
</li>
<li>sart (×) = rcp (rsqrt (x)) : map to HW</li>
<li>if0=&gt;sign(×) if/else=&gt;step(×) lerp (a, b, step (cx, cy));</li>
<li>sin/cos/sincos &lt;&lt; asin/acos/atan/atan2/degrees/radians</li>
<li>mul(v.m) v.x*m[0] +v.y*m[1] + v.z*m[2] + v.w*m[3] : MAD-MAD-MAD</li>
<li>mul(float4(v.xyz, 1)) v.×*m[0] + v.y*m [1] + v.z*m [2] + m[3] : MUL-MAD-MAD-MAD</li>
<li>v.x*m[01 + (v.y*m[1]+(v.z*m|2] + m[3])) : MUL-MAD-MAD-ADD</li>
<li>normalize/length/distance都包含一个dot，可以共亨，length(a-b)与distance(a，b)可共享，但与distance(b，a)不共享</li>
<li>normalize (vec) = vec * rsart(dot (vec, vec) ) ; 50*normalize (vec) -&gt; vec(50 * rsqrt(dot(vec, vec)))</li>
<li>自表达式不共享指令
<ul>
<li>if(length(v) &gt; 1.0)</li>
<li>V = normalize (v)</li>
<li>return v</li>
</ul>
</li>
<li>mul =&gt; mul24(高版本用于向量前三个相乘)</li>
<li>fma 注重精度的mad</li>
<li>texture.Load VS texture.Sample, Load (tc, offset) &gt; Samole (tc, offset)</li>
<li>FS=&gt;VS，均衡GPU着色器负载</li>
<li>避免隐式转换，Vector4转成Vector3</li>
<li>Varying数据尽可能组织成向量形式，而非标量，从而减少MissCache</li>
</ul>
<h4 id="其他指令优化">其他指令优化</h4>
<ul>
<li>[branch]UNITY_BRANCH ：真分支是否动态判断，语句比较多，且大概率走其中某一条分支</li>
<li>[flatten]UNITY_FLATTEN ：分支是否展开，分支语句比较简单的情况，比如少于6条语句的分支</li>
<li>[loop] UNITY_LOOP ：循环语句不展开，标记为真循环</li>
<li>[unroll] UNITY_UNROLL ：循环语句展开</li>
<li>[unroll(_x)] UNITY_UNROLL (_x) ：循环语句展开到第几层</li>
</ul>
<h4 id="Early-z失效">Early-z失效</h4>
<ul>
<li>开启Alpha Test</li>
<li>Clip()</li>
<li>Discard</li>
<li>Alpha Coverage</li>
<li>光栅化后修改深度</li>
<li>手动关闭Depth Test</li>
</ul>
<h4 id="某些平台慎用或推荐用某些内置功能">某些平台慎用或推荐用某些内置功能</h4>
<ul>
<li>Alpha Test，需要真机测验</li>
<li>Color Mask，需要真机测验</li>
<li>sRGB硬件解压，大多数平台推荐用</li>
</ul>
<h2 id="内存优化">内存优化</h2>
<h3 id="Unity中的内存概述与工具方法">Unity中的内存概述与工具方法</h3>
<table>
<thead>
<tr>
<th>Unity中的内存</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>托管内存</td>
<td>主要是指使用托管堆或者垃圾收集器自动分配和管理的内存也包括脚本堆栈与虚拟机内存（unity目前使用的贝母垃圾回收器比较保守）</td>
</tr>
<tr>
<td>C#非托管内存</td>
<td>可以在C#下与Unity Collection名字空间和包结合使用，不使用垃圾收集器管理的内存部分</td>
</tr>
<tr>
<td>Native内存</td>
<td>Unity用于运行引擎的C++内存</td>
</tr>
</tbody>
</table>
<p>Unity应用程序的内存主要有：</p>
<ul>
<li>Unity中的内存
<ul>
<li>托管内存</li>
<li>C#非托管内存</li>
<li>Native内存</li>
</ul>
</li>
<li>显存</li>
<li>其他内存
<ul>
<li>应用程序框架</li>
<li>第三方库</li>
<li>系统内存</li>
</ul>
</li>
</ul>
<p>内存工具：</p>
<ul>
<li>Profiler的内存分页，可以添加自定义memory module</li>
<li>Memory Profiler：抓取内存快照</li>
<li>UPR工具内存页</li>
<li>Xcode-Profile-Allocations（可以看非Unity内存部分），VM Tracker需要勾选Automatic Snapshoting
<ul>
<li>Dirty Size：不能被复用或卸载的内存块，比较重要，超过上限iOS程序会退出</li>
<li>Swapped Size：不活跃的内存，可以被交换到磁盘上的大小</li>
<li>Resident Size：使用的物理内存量</li>
<li>Allocations-Call Tree-按线程分类，可以查看指定时间内某线程分配内存的堆栈情况</li>
</ul>
</li>
</ul>
<h3 id="Unity中Allocator详解">Unity中Allocator详解</h3>
<p>对内存分配的封装分配器，用来拓展内存统计、检查和管理</p>
<p>Memory Setting：<a target="_blank" rel="noopener" href="https://docs.unity3d.com/cn/current/Manual/performance-garbage-collection-best-practices.html">https://docs.unity3d.com/cn/current/Manual/performance-garbage-collection-best-practices.html</a></p>
<h4 id="按用途分类">按用途分类</h4>
<ul>
<li>Main Allocators：绝大数内存分配，主线程渲染资源相关、文件cache、typetree等不同用途下的分配器</li>
<li>Fast Per Thread Temporary Allocators：线程上使用的临时分配器，包括各工作线程使用的栈分配器，比如音乐、渲染、预加载、烘焙等工作线程上的分配器</li>
<li>Fast Thread Shared Temporary Allocators：线程间共享的临时分配器</li>
<li>Profiler Allocators：用于profiler使用的分配器</li>
</ul>
<h4 id="按底层类型分类">按底层类型分类</h4>
<ul>
<li>UnityDefaultAllocator</li>
<li>BucketAllocator</li>
<li>DynamicHeapAllocator</li>
<li>DualThreadAllocator</li>
<li>TLSAllocator(Thread Local Storage)</li>
<li>StackAllocator</li>
<li>ThreadSafeLinearAllocator</li>
<li>…</li>
</ul>
<h4 id="Unity中的内存分配器">Unity中的内存分配器</h4>
<table>
<thead>
<tr>
<th>分配器类型</th>
<th>分配器算法</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bucket 桶分配器</td>
<td>Two Level Segregated Fit(TLSF)</td>
<td>- Main allocator<br> - Gfx allocator<br> - Typetree allocator<br> - File cache allocator<br> - Profiler allocator<br> - Editor Profiler allocator (on Editor only)<br></td>
</tr>
<tr>
<td>Dynamic Heap动态堆分配器</td>
<td>Fixed size lock-free allocator</td>
<td>As a shared allocator for small allocations for:<br> - Main allocator<br> - Gfx allocator<br> - Typetree allocator<br> - File cache allocator</td>
</tr>
<tr>
<td>Dual thread</td>
<td>Redirects allocations based on size and thread ID</td>
<td>- Main allocator<br> - Gfx allocator<br> - Typetree allocator<br> - File cache allocator</td>
</tr>
<tr>
<td>Thread Local Storage(TLS) stack</td>
<td>LIFO stack</td>
<td>Temporary allocations</td>
</tr>
<tr>
<td>Threadsafe linear</td>
<td>Round robin FIFO</td>
<td>Buffers for passing data to jobs</td>
</tr>
</tbody>
</table>
<h4 id="BucketAllocator-桶分配器）">BucketAllocator(桶分配器）</h4>
<ul>
<li>每个bucket由固定大小粒度granularity表示，如果granularity为16字节大小，则用于分配<br>
16/32/48/54/…字节的内存，如果是development版本granularity在设置大小的基础上增加40个<br>
字节</li>
<li>分配器为分配保留内存块Block，每个块被划分为16kb的子段(subsections),并且不可配置。<br>
Block块只能增长,并且需要是固定16kb大小的整数倍。</li>
<li>分配是固定大小无锁的，速度快，通常作为进入堆分配器之前用来加速小内存分配的分配器</li>
<li>Log日志中可以通过查看[ALLOC_BUCKET]字段来看是否有Failed Allocations. Bucket layout字段，以及Peak Allocated bytes字段与Large Block size字段的利用率，来判定大小是否分配合适，</li>
<li>分配失败会会退到DynamicHleapAllocator或UnityDefaultAllocator分配器上，效率变差。</li>
</ul>
<h4 id="DynamicHeapAllocator-动态堆分配器）">DynamicHeapAllocator(动态堆分配器）</h4>
<ul>
<li>所有平合都希望使用的分配器 （Mac与iOS哲时仍然使用Unity DefaultAllocator，可以理解为原生的alloc和free）</li>
<li>底层基于TLSF，保留tsf块列表，并在一个块已满后，切换到另一个块,或没有时分配一个新块,关<br>
于TLSF :<a target="_blank" rel="noopener" href="http://www.gii.upv.es/tlsf/files/ecrts04_tlsf.pdf">http://www.gii.upv.es/tlsf/files/ecrts04_tlsf.pdf</a></li>
<li>最棘手的部分是设置块的大小。根据不同平合，更大的块效率更高，碎片更少，但对于内存有限的平台来说灵活性差</li>
<li>最大块为256M，最小块为128k，如果64位架构使用更大的Reaion来保存多个块<br>
MEMORY_USE_LARGE_BLOCKS，如果分配失败会会退到虛拟内存分配，效率更差</li>
<li>Log中[ALLOC_DEFAULT_MAIN]下关注Peak usage frame count字段，查看大多数帧分配内存的范圃，关注内存分配峰值Peak Allocated memory字段，以区Peak Large allocation bytes没有使用TLSF分配的内存大小</li>
</ul>
<h4 id="DualThreadAllocator">DualThreadAllocator</h4>
<ul>
<li>它是将2个DynamicHeapAllocator实例与1个BucketAllocator封装到一起，其中BucketAllocator负责小的共享内存分配，1个无锁的DynamicHeapAllocator用于主线程分配，另外一个DynamicHleapAllocator负责其他线程的共享分配，但是分配与回收时需要加锁</li>
<li>Log中[ALLOC_DEFAULT]下分别关注[ALLOC_BUCKET]、[ALLOC_DEFAULT_MAIN]、[ALLOC_DEFAULT_THREAD]字段下一个BucketAllocator与2个DynamicHeapAllocator的分配信息，其中尤其关注Peak main deferred allocation count字段，这个字段代表需要在主线程回收的分配队列。</li>
<li>负责其他线程的共享分配的DynamicHeapAllocatord对应C#非托管内存的Allocator.Persistent</li>
</ul>
<h4 id="TLS-Stack-Allocator">TLS Stack Allocator</h4>
<ul>
<li>用于快速临时分配的堆栈分配器。它是最快的分配器，几乎没有开销，并且可以防止内存碎片，对应C#非托管内存的Allocator.Temp分配类型</li>
<li>它是基于后进先出LIFO的算法，分配的内存生命周期在一帧内。</li>
<li>如果分配器使用超过了配置的大小，Unity会增加分配块大小，但会是配置设置的2倍大小，</li>
<li>如果线程堆栈分配器满了，分配器将会退到线程安全线性job分配器。这时一帧内允许有1-10分配，甚至如果是加载期间可以允许几百次。但如果每帧的分配数字增加可以考虑增加块大小。</li>
<li>Log日志[ALLOC_TEMP_TLSJ下关注[ALLOC TEMP_MAIN]与[ALLOC TEMP Job.Worker xx]中的Peak usage frame count于Peak Allocated Bytes字段，也要关注Overtlow Count字段，是否发生了分配器溢出回退的情況。</li>
</ul>
<h4 id="Thread-Safe-Linear-Allocator">Thread Safe Linear Allocator</h4>
<ul>
<li>用于快速无锁分配Job线程的缓冲区，并在Job完成后释放缓冲区，对应C#非托管内存的Allocator.TempJob</li>
<li>采用循环先进先出FIFO算法，先分配内存块，然后在这些内存块内进行线性分配内存所有可用块都会存到一个池中，当一个块满时再从池中提取一个新的可用块。当分配器不再需要块中内存时，清理该块并放回到可用池中。快速清理分配可用块非常重要。因此Job的分配尽量在几帧内完成。</li>
<li>如果所有块都在使用中，或者一个分配对于一个块太大的情况下，则会退到主堆分配<br>
器，分配效率会下降。</li>
<li>Log日志[ALLOC_ TEMP_ JOB_4_FRAMESJ中我们需要关注Overflow Cout(too large)与Overtlow Count(full)字段，判断是否发生了分配器溢出会退。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304161634019.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304161634173.png" alt=""></p>
<h3 id="内存指标术语与进程内存结构">内存指标术语与进程内存结构</h3>
<h4 id="Memory-Profiler中的内存度量与术语">Memory Profiler中的内存度量与术语</h4>
<ul>
<li>Page操作系统内存管理的最小单元（通常是4KB大小，但不同操作系统和平台会有所不同）</li>
<li>内存管理单元MMU，维护一张Page的表，将虚拟地址映射到物理内存地址上。</li>
<li>当用户访问虚拟地址时，会自动被MMU转换到物理内存地址，但如果CPU没有找到虚拟地址映射的物理内存地址时，会触发page fault中断当前程序执行，然后再分配一块干净的物理内存，并从磁盘加载所需的一页数据到该物理地址，同时更新页表，继续执行</li>
<li>一个进程向系统申请内存时，并不会返回物理内存地址，而是返回虚拟内存地址，仅当CPU需要访问该虚拟地址时，系统才会分配并映射到物理内存上</li>
<li>Page的状态
<ul>
<li>Used，Page正在被进程使用，内存页也映射到物理内存中</li>
<li>Free，该page可用，且内存页还没有被映射到物理内存中</li>
<li>Cache，该Page被操作系统用于缓存的可用内存，虽然内存页已经被映射到物理内存中，但该Page可能近期没有被访问，如果Free page低于阈值时，操作系统会从Cache去获取内存，并将Cache页数据交换到磁盘，然后对Cache页进行清理，标记为Free Cache</li>
</ul>
</li>
<li>Region，将Page组织成区域，是一块共享内存状态和保护级别的连续地址空间，可以由具有不同page状态的多个页面组成</li>
<li>Region的状态
<ul>
<li>Resident：其中的配置页已经在物理内存中</li>
<li>Dirty：配置已修改，但未写入磁盘</li>
<li>Wired：代表永远不会交换到辅助存储的固定配置段</li>
<li>Committed：代表已分配的内存区域，其地址不能被其他分配使用，是由RAM、磁盘上的分页文件或其他资源来支持的，访问权限由内存的保护级别控制</li>
<li>Reserved：保留地址空间供将来使用，地址不会被其他分配使用，也不可访问，没有与之关联的物理存储</li>
<li>Free：空闲内存区域，既不会Committed也不会Reserved，进程无法访问</li>
</ul>
</li>
<li>Region的类型
<ul>
<li>Anonymous：与文件系统的文件并无关联，如c++使用malloc的任何分配</li>
<li>Mapped：与文件系统、设备节点相关联，直接映射</li>
</ul>
</li>
</ul>
<h4 id="进程的内存结构">进程的内存结构</h4>
<ul>
<li>USS ：当前进程私有的Resident内存总和</li>
<li>PSS ：当前进程常驻内存与其他进程共享的Resident内存总和</li>
<li>RSS ：进程可访问的Resident常驻内存总和</li>
<li>VSS : 总共Committed提交的Region内存总和</li>
</ul>
<p><img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304161709819.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/202304161709332.png" alt=""></p>
<h4 id="各工具的内存指标">各工具的内存指标</h4>
<ul>
<li>Unity Memory Profiler是对VSS进行衡量的</li>
<li>Windows资源管理器的内存指标是针对USS衡量</li>
<li>Xcode上内存指标是RSS+压缩后内存交换页的大小</li>
</ul>
<h3 id="移动平台内存经验值数据分享">移动平台内存经验值数据分享</h3>
<ul>
<li>Texture: 80M-160M</li>
<li>Mesh: 50M-70M</li>
<li>Render Texture: 50-80M</li>
<li>AnimationClips: 30-60M</li>
<li>Audio: 10-20M</li>
<li>Cubemap: 0-50M</li>
<li>Font: 5M-15M</li>
<li>Shader: 20M-40M（小心shader变体，看这篇https://blog.unity.com/engine-platform/stripping-scriptable-shader-variants）</li>
<li><a target="_blank" rel="noopener" href="http://System.xxx">System.xxx</a> 总和：15M-30M（不要将大的配置表缓存进内存，特别是文本数据）</li>
<li>AssetBundle: 0-10M</li>
<li>其他各类对象单项：0-10M,数量小于10000</li>
<li>ReservedMono: &lt;100M</li>
<li>ReservedGFX: &lt;300M</li>
<li>ReservedTotal: &lt;650M</li>
</ul>
<h3 id="主要优化手段">主要优化手段</h3>
<ul>
<li>导入资源优化设置</li>
<li>如果Mesh占用的内存过高，就要考虑Static Batching使用是否划算了，可以在player setting中一键关闭</li>
<li>如果使用了Terrain烘焙Mesh的方案，会造成顶点数和内存增高，考虑是否需要烘焙的优化方案</li>
<li>RT纹理需要去除冗余资源，以及分辨率调整</li>
<li>HDR纹理占用内存会增多一半左右</li>
<li>Texture2d纹理可以强制控制（Texture Quality）某个平台使用某一级别以及以下级别的mipmap纹理，但这个需要运行前确认，适用于高中低机型调整
<ul>
<li>利用Mipmap Streaming功能可以运行时动态调整mipmap层级，使用少量cpu资源来降低GPU显存使用</li>
<li>使用Streaming Controller脚本控制相机的mipmap bias偏移</li>
<li>Unity关于Mipmap Streaming的示例项目+UI调试项目 <a target="_blank" rel="noopener" href="https://github.com/lwwhb/MipMapStreamingDemo">https://github.com/lwwhb/MipMapStreamingDemo</a></li>
</ul>
</li>
<li>使用Editor.log查看打包shader 变体情况（剔除与收集），2022有dynamic_branch关键字，不会产生变体的分支</li>
<li>托管内存优化技巧与建议
<ul>
<li>Boxing Allocation装箱操作</li>
<li>使用lua和unity交互时，尽量不要传递unity内存对象，而是传递或返回基础类型值对象，lua内存查看：<a target="_blank" rel="noopener" href="https://github.com/leinlin/Miku-LuaProfiler">https://github.com/leinlin/Miku-LuaProfiler</a></li>
<li>Stringt字符串拼接</li>
<li>闭包分配</li>
<li>避免使用Linq库，会生成大量托管堆垃圾内存</li>
<li>Unity中提供了NonAlloc函数，如Physics.RayCastAll用Physics.RayCastAlINonAlloc代替</li>
<li>有托管内存开销：Unity.Object.FindObjectsOfType、UnityEngine.Component.GetComponentsInParent、UnityEngine.Component.GetComponentslnChild 等</li>
<li>成员变量访问方式
<ul>
<li>UnityEngine.Mesh.vertices=&gt; UnityEngine.Mesh.GetVertices,</li>
<li>UnityEngine.Mesh.uv=&gt; UnityEngine.Mesh.GetUV</li>
<li>UnityEngine.Renderer.sharedMaterials=&gt;UnityEngine.Renderer.GetSharedMaterials,</li>
<li>Unity.lnput.touches=&gt;Unity.lnput.GeTouches等</li>
</ul>
</li>
<li>程序集优化：Strip Engine Code</li>
</ul>
</li>
</ul>

      </section>

      
      
        <nav class="article-nav">
          
            <div class="article-nav-item layout-padding">
  <article class="card-container article-nav-card content-padding--primary soft-size--large soft-style--box">
    
    <div class="card-text">
      
        <a href="/posts/c33c353/" itemprop="url">
          <h2 class="card-text--title text-ellipsis">《Unity性能优化》-- 5.1 性能优化实战理论</h2>
        </a>
      
      <div class="card-text--row">Newer</div>
    </div>
  </article>
</div>
          
          
            <div class="article-nav-item layout-padding">
  <article class="card-container article-nav-card content-padding--primary soft-size--large soft-style--box">
    
    <div class="card-text">
      
        <a href="/posts/e690dd38/" itemprop="url">
          <h2 class="card-text--title text-ellipsis">《Unity性能优化》-- 4. 性能优化之道</h2>
        </a>
      
      <div class="card-text--row">Older</div>
    </div>
  </article>
</div>
          
        </nav>
      

      <section class="page-message-container layout-padding">
        


  
  
    <div class="valine-container comments-container content-padding--primary soft-size--large soft-style--box">
      <div id="valine_thread" class="valine-thread"></div>
    </div>
    <script type="text/javascript" src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script type="text/javascript" src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <script type="text/javascript">
      new Valine({
        el: "#valine_thread",
        appId: "ha5sLVmWShqJe8avY2CWYZlD-gzGzoHsz",
        appKey: "4p6G2ba4Q1lK0tPKyeZRmhUu",
        avatar: "mm",
        placeholder: "随便说点什么叭～",
        notify: true,
        visitor: true,
        pageSize: 10,
      });
    </script>
  

  
  


      </section>
    </div>
    <div class="widget-info">
      <section class="widget-author widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-body">
    
      <img src="https://raw.githubusercontent.com/kiodyd/image-host/main/PicGo/20230104205054.png" class="soft-size--round soft-style--box" alt="kio0o0">
    
    
      <h2>kio0o0</h2>
    
    
      <p>如果可以做到不懂就问，做不到的事情就拒绝，或许可以活得更轻松点</p>
    

    <div class="count-box">
      <div class="count-box--item">
        <svg class="icon icon-article" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M240.51564747 647.74217627h196.07203239c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806V165.10332731c0-33.18142087-30.16492806-60.32985613-60.32985612-60.32985611H245.04038668C225.43318342 104.7734712 210.35071939 119.85593522 210.35071939 139.46313845V617.57724821c0 16.59071043 13.57421762 30.16492806 30.16492808 30.16492806z m663.62841731-452.47392089v482.63884894c0 33.18142087-27.14843525 60.32985613-60.32985612 60.32985613H180.18579134c-33.18142087 0-60.32985613-27.14843525-60.32985612-60.32985613V195.26825538c-49.77213131 0-90.49478418 40.72265287-90.49478417 90.49478417v452.4739209c0 49.77213131 40.72265287 90.49478418 90.49478417 90.49478417h286.56681657c16.59071043 0 30.16492806 13.57421762 30.16492807 30.16492807s13.57421762 30.16492806 30.16492805 30.16492806h90.49478418c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806s13.57421762-30.16492806 30.16492807-30.16492807h286.56681657c49.77213131 0 90.49478418-40.72265287 90.49478417-90.49478417V285.76303955c0-49.77213131-40.72265287-90.49478418-90.49478417-90.49478417zM587.41232014 647.74217627h191.54729318c19.60720323 0 34.68966726-15.08246403 34.68966729-34.68966727V134.93839925c0-16.59071043-13.57421762-30.16492806-30.16492808-30.16492805H617.57724821c-30.16492806 0-60.32985613 27.14843525-60.32985612 60.32985611v452.4739209c0 16.59071043 13.57421762 30.16492806 30.16492805 30.16492806z" fill="currentColor"></path>
</svg>
        <span>102</span>
      </div>
      <div class="count-box--item">
        <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
        6
      </div>
      <div class="count-box--item">
        <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
        26
      </div>
    </div>
  </div>
</section>

      

      
<section class="widet-notice widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-notice" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 945.02305225v28.15620663a24.27259221 24.27259221 0 0 1-24.27259221 24.27259335H394.0352a48.54518557 48.54518557 0 0 1-41.74885888-23.78714112l-110.68302222-184.47170332a132.04290333 132.04290333 0 0 1-17.47626667-48.54518557h118.4502511a200.97706667 200.97706667 0 0 1 76.21594113 14.56355556l20.38897777 133.49925888a48.54518557 48.54518557 0 0 0 36.40888888 27.67075555l16.01991111 2.91271112a24.27259221 24.27259221 0 0 1 20.38897778 25.72894889zM997.45185223 463.45481443a194.18074112 194.18074112 0 0 1-38.8361489 116.50844445 24.75804445 24.75804445 0 0 1-36.4088889 0l-34.95253333-34.95253333a24.27259221 24.27259221 0 0 1-2.91271111-30.58346667 97.09036999 97.09036999 0 0 0 0-106.79940665 24.27259221 24.27259221 0 0 1 2.91271111-30.58346666l34.95253333-34.95253334a24.75804445 24.75804445 0 0 1 18.93262223-7.28177777 26.2144 26.2144 0 0 1 17.47626667 9.70903665A194.18074112 194.18074112 0 0 1 997.45185223 463.45481443z m-194.18074112-388.36148111v776.72296335a48.54518557 48.54518557 0 0 1-48.54518556 48.54518443h-28.64165888a48.54518557 48.54518557 0 0 1-33.98163001-14.07810332l-145.63555556-143.20829668A291.27111111 291.27111111 0 0 0 342.57730333 657.63555556H172.18370333a145.63555556 145.63555556 0 0 1-145.63555556-145.63555556v-97.09036999a145.63555556 145.63555556 0 0 1 145.63555556-145.63555556h170.3936a291.27111111 291.27111111 0 0 0 206.31703779-85.43952668l145.63555555-143.20829554a48.54518557 48.54518557 0 0 1 33.98162888-14.07810446H754.72592555a48.54518557 48.54518557 0 0 1 48.54518556 48.54518555z" fill="currentColor"></path>
</svg>
    <span>NOTICE</span>
  </div>
  <div class="widget-body">
    <p>正在努力学习图形学中！</p>
  </div>
</section>


      <section class="widget-categorys widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
    <span>CATEGORYS</span>
  </div>
  <div class="widget-body">
    <ul class="categorys-list">
      
        <li class="categorys-list-item">
          <a href="/categories/%E5%B7%A5%E4%BD%9C/">
            工作 (1)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E8%BD%AF%E4%BB%B6/">
            软件 (2)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E6%9D%82%E8%B0%88/">
            杂谈 (1)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E7%A1%AC%E4%BB%B6/">
            硬件 (2)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/">
            学习 (95)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E5%8A%A8%E7%94%BB/">
            动画 (1)
          </a>
        </li>
      
    </ul>
  </div>
</section>

      <section class="widget-tags widget-item  layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
    <span>TAGS</span>
  </div>
  <div class="widget-body">
    <div class="tags-cloud">
      <a href="/tags/AMD-OS-X/" style="font-size: 10px;" class="tags-cloud-0">AMD OS X</a> <a href="/tags/C-%E7%AC%94%E8%AE%B0/" style="font-size: 16.67px;" class="tags-cloud-7">C#笔记</a> <a href="/tags/Github%E6%8A%80%E5%B7%A7/" style="font-size: 10px;" class="tags-cloud-0">Github技巧</a> <a href="/tags/Hackintosh/" style="font-size: 10px;" class="tags-cloud-0">Hackintosh</a> <a href="/tags/Lua%E7%AC%94%E8%AE%B0/" style="font-size: 10px;" class="tags-cloud-0">Lua笔记</a> <a href="/tags/Unity/" style="font-size: 15.56px;" class="tags-cloud-6">Unity</a> <a href="/tags/Unity-Shader%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81/" style="font-size: 17.78px;" class="tags-cloud-8">Unity Shader入门精要</a> <a href="/tags/c-%E7%AC%94%E8%AE%B0/" style="font-size: 12.22px;" class="tags-cloud-2">c++笔记</a> <a href="/tags/cocos/" style="font-size: 10px;" class="tags-cloud-0">cocos</a> <a href="/tags/c%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0/" style="font-size: 11.11px;" class="tags-cloud-1">c语言笔记</a> <a href="/tags/drcom/" style="font-size: 10px;" class="tags-cloud-0">drcom</a> <a href="/tags/shader/" style="font-size: 10px;" class="tags-cloud-0">shader</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1/" style="font-size: 13.33px;" class="tags-cloud-3">代码设计</a> <a href="/tags/%E5%8D%A1%E9%80%9A%E6%B8%B2%E6%9F%93/" style="font-size: 10px;" class="tags-cloud-0">卡通渲染</a> <a href="/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6/" style="font-size: 20px;" class="tags-cloud-10">图形学</a> <a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;" class="tags-cloud-0">学习</a> <a href="/tags/%E5%B9%B3%E6%9D%BF/" style="font-size: 11.11px;" class="tags-cloud-1">平板</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 14.44px;" class="tags-cloud-4">性能优化</a> <a href="/tags/%E6%90%9E%E6%9C%BA/" style="font-size: 10px;" class="tags-cloud-0">搞机</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10px;" class="tags-cloud-0">数据结构</a> <a href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/" style="font-size: 10px;" class="tags-cloud-0">游戏开发</a> <a href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" style="font-size: 18.89px;" class="tags-cloud-9">百人计划</a> <a href="/tags/%E8%A7%A3%E9%A2%98/" style="font-size: 10px;" class="tags-cloud-0">解题</a> <a href="/tags/%E8%AE%A1%E5%88%92/" style="font-size: 10px;" class="tags-cloud-0">计划</a> <a href="/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/" style="font-size: 10px;" class="tags-cloud-0">路由器</a> <a href="/tags/%E9%87%8D%E6%9E%84/" style="font-size: 13.33px;" class="tags-cloud-3">重构</a>
    </div>
  </div>
</section>
    </div>
  </article>
</div>

    <!-- footer container -->
<footer id="footer" class="footer">
  <div class="footer-container">
    
    <div class="social-icons">
      
        
      
        
      
        
      
        
          <a href="https://github.com/kiodyd" class="soft-size--primary soft-style--box" target="_blank" rel="noopener noreferrer">
            <svg class="icon icon-github" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64.6 512c0 195.6 125.4 361.9 300.1 422.9 23.5 5.9 19.9-10.8 19.9-22.2v-77.6c-135.8 15.9-141.3-74-150.5-89-18.5-31.5-61.9-39.5-49-54.5 31-15.9 62.5 4 98.9 58 26.4 39.1 77.9 32.5 104.1 26 5.7-23.5 17.9-44.5 34.7-60.9-140.7-25.2-199.4-111.1-199.4-213.3 0-49.5 16.4-95.1 48.4-131.8-20.4-60.6 1.9-112.4 4.9-120.1 58.2-5.2 118.5 41.6 123.3 45.3 33.1-8.9 70.8-13.7 112.9-13.7 42.4 0 80.3 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.4-43.9 2.9 7.7 24.7 58.3 5.5 118.1 32.5 36.8 49 82.8 49 132.4 0 102.3-59 188.3-200.2 213.2 23.5 23.3 38.1 55.5 38.1 91.1v112.7c0.8 9 0 17.9 15.1 17.9C832.7 877 960.4 709.4 960.4 512.1c0-247.5-200.6-447.9-447.9-447.9C265 64.1 64.6 264.5 64.6 512z"></path>
</svg>
          </a>
        
      
        
      
    </div>
     
    <p>&copy; 2024 <a href="/" target="_blank">kio0o0</a></p>

    

    <p>Powered by <a href="https://hexo.io" target="_blank" rel="noopener noreferrer">Hexo</a> Theme - <a href="https://github.com/miiiku/flex-block" target="_blank" rel="noopener noreferrer author">flex-block</a></p>

    <p>
      <a href="javascript:;" id="theme-light">🌞 浅色</a>
      <a href="javascript:;" id="theme-dark">🌛 深色</a>
      <a href="javascript:;" id="theme-auto">🤖️ 自动</a>
    </p>
  </div>
</footer>
  </div>

  <div class="back-to-top-fixed soft-size--round soft-style--box">
    <svg class="icon icon-back-to-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <path d="M725.333333 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733333s42.666667-17.066667 59.733333 0l213.333333 213.333333c17.066667 17.066667 17.066667 42.666667 0 59.733333C746.666667 422.4 738.133333 426.666667 725.333333 426.666667z"></path>
      <path d="M298.666667 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8-17.066667-17.066667-17.066667-42.666667 0-59.733333l213.333333-213.333333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733333l-213.333333 213.333333C320 422.4 311.466667 426.666667 298.666667 426.666667z"></path>
      <path d="M512 896c-25.6 0-42.666667-17.066667-42.666667-42.666667L469.333333 170.666667c0-25.6 17.066667-42.666667 42.666667-42.666667s42.666667 17.066667 42.666667 42.666667l0 682.666667C554.666667 878.933333 537.6 896 512 896z"></path>
    </svg>
  </div>

  
  <!-- aplayer -->


<!-- dplayer -->




  


  


  




<script src="/js/script.js"></script>


  
  <!-- 尾部用户自定义相关内容 -->
</body>
</html>
